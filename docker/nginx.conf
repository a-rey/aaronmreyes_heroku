daemon off;         # https://nginx.org/en/docs/ngx_core_module.html#daemon
worker_processes 4; # host number of cores: "grep "processor" /proc/cpuinfo | wc -l"
pid /tmp/nginx.pid; # http://nginx.org/en/docs/ngx_core_module.html#pid

events {
  # http://nginx.org/en/docs/ngx_core_module.html#worker_connections
  worker_connections 1024;
}

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# HTTP Server Configuration
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
http {
  # include default nginx mime types
  include       /etc/nginx/mime.types;
  # http://nginx.org/en/docs/http/ngx_http_core_module.html#default_type
  default_type  application/octet-stream;
  # define main log format
  log_format    main '$remote_addr [$time_local] "$request" '
                     '$status $body_bytes_sent "$http_referer" '
                     '"$http_user_agent" "$http_x_forwarded_for"';
  # http://nginx.org/en/docs/http/ngx_http_log_module.html#access_log
  access_log    /var/log/nginx/access.log main;
  # http://nginx.org/en/docs/ngx_core_module.html#error_log
  error_log     /var/log/nginx/error.log warn;
  # http://nginx.org/en/docs/http/ngx_http_core_module.html#sendfile
  sendfile      on;
  # http://nginx.org/en/docs/http/ngx_http_core_module.html#tcp_nopush
  tcp_nopush    on;
  # http://nginx.org/en/docs/http/ngx_http_core_module.html#server_tokens
  server_tokens off;
  # http://nginx.org/en/docs/http/ngx_http_gzip_module.html#gzip
  gzip          off;

  # ---------------------------------------------------------------------------
  # DDOS Protection
  # ---------------------------------------------------------------------------
  # http://nginx.org/en/docs/http/ngx_http_core_module.html#client_body_timeout
  client_body_timeout   10s;     # default: 60s
  # http://nginx.org/en/docs/http/ngx_http_core_module.html#client_header_timeout
  client_header_timeout 10s;     # default: 60s
  # http://nginx.org/en/docs/http/ngx_http_core_module.html#keepalive_timeout
  keepalive_timeout     10s 10s; # default: 75s
  # http://nginx.org/en/docs/http/ngx_http_core_module.html#send_timeout
  send_timeout          10s;     # 6default: 0s

  # ---------------------------------------------------------------------------
  # Internal Network ACL for Django Admin Application Access
  # ---------------------------------------------------------------------------
  map $remote_addr $acl_block_external_addr {
    default 1;
    ### INTERNAL ###
    10.0.0.0/24 0;
  }

  # ---------------------------------------------------------------------------
  # Front-end Docker network connection to Django application
  # ---------------------------------------------------------------------------
  upstream docker_django_app {
    # NOTE: hostname/port below must match docker django application
    server django:8000;
  }

  # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  # Port 8080: Default Server
  # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  server {
    # prevent processing requests to undefined server names
    listen      0.0.0.0:8080 default_server;
    server_name "";
    # close connection without response
    return      444;
  }

  # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  # Port 4443: Default Server
  # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  server {
    # prevent processing requests to undefined server names
    listen      0.0.0.0:4443 ssl default_server;
    server_name "";
    # close connection without response
    return      444;
  }

  # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  # Port 8080: Plain Text HTTP
  # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  server {
    listen      0.0.0.0:8080;
    server_name arey.dev;

    # for LetsEncrypt certification ACME request renewals
    location /.well-known/acme-challenge/ {
      root /__certbot/;
    }

    # redirect to HTTPS if not an ACME request
    location / {
      return 301 https://arey.dev$request_uri;
    }
  }

  # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  # Port 4443: SSL Encrypted HTTP
  # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  server {
    listen      0.0.0.0:4443 ssl;
    server_name arey.dev;

    # -------------------------------------------------------------------------
    # TLS Configuration
    # -------------------------------------------------------------------------
    ssl_certificate     /etc/letsencrypt/live/arey.dev/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/arey.dev/privkey.pem;

    # -------------------------------------------------------------------------
    # Proxy Headers
    # -------------------------------------------------------------------------
    proxy_set_header Host               $host;
    proxy_set_header X-Forwarded-Proto  https;
    proxy_set_header X-Real-IP          $remote_addr;
    proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header X-Host             "";
    proxy_set_header X-Rewrite-URL      "";
    proxy_set_header X-Original-URL     "";
    proxy_set_header X-Forwarded-Host   "";
    proxy_set_header X-Forwarded-Server "";

    # Django static files storage
    location /static/ {
      alias /__staticfiles/;
    }

    # Django admin application
    location /backdoor/ {
      if ($acl_block_external_addr) {
        # close connection without response
        return 444;
      }
      proxy_redirect off;
      proxy_pass     http://docker_django_app/;
    }

    # Django user applications
    location / {
      proxy_redirect off;
      proxy_pass     http://docker_django_app/;
    }
  }
}

